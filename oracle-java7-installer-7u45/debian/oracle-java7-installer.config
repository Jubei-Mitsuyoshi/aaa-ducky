#!/bin/sh

set -e

. /usr/share/debconf/confmodule


### Variables
VER='0.7'
UBUNTUARCH=$(uname -m)

# Folders
J_INSTALL_DIR=/usr/lib/jvm/java-7-oracle
OLDDIR=/usr/lib/oracle-jdk7-installer-unpackdir
NEWDIR=/var/cache/oracle-jdk7-installer

# Must be modified for each release
JAVA_VERSION=7u45
J_DIR=jdk1.7.0_45

# Filenames and checksums
case $(uname -m) in
'i686'|'i586')
	arch=i386; dld=i586
	# Must be modified for each release
	SHA256SUM_TGZ="4acbdc25d0acad7c765b65c13cda44150200c33507bfe8b5ce6cabcab3e016e0"
	;;
'x86_64')
	arch=amd64; dld=x64
	# Must be modified for each release
	SHA256SUM_TGZ="f2eae4d81c69dfa79d02466d1cb34db2b628815731ffc36e9b98f96f46f94b1a"
	;;
arm*)
	arch=arm
	if [ $UBUNTUARCH = "armv7l" ] || [ $UBUNTUARCH = "armv6l" ]; then
		if [ -x /usr/bin/readelf ] ; then
			HARDFLOAT=`readelf -A /proc/self/exe | grep Tag_ABI_VFP_args`
			if [ -z "$HARDFLOAT" ]; then
				# Softfloat
				dld='arm-vfp-sflt'
				# Must be modified for each release
				SHA256SUM_TGZ="5026a8f2eea8d350ea6ed7cfb8496b571ec9c1e43db82750a3ca8dc02569076e"
			else
				# Hardfloat
				dld='arm-vfp-hflt'
				# Must be modified for each release
				SHA256SUM_TGZ="97d8994f94e891540901271a889539dcb7addc52264b025ee5d4cbcec3e0ad0b"
			fi
		fi
	else
		echo "Oracle JDK 7 only supports ARM v6/v7."
		arch=''
	fi
	;;
*)
	echo "Please report to author unsupported platform '`uname -m`'.";
	echo "Proceeding without web browser plugin support";
	arch='';
esac
FILENAME=jdk-${JAVA_VERSION}-linux-${dld}.tar.gz
for JAVA_VERSION_OLD in `seq 1 44`; do #must be modified for each release ("1 3" for 7u4; "1 4" for 7u5, etc)
	FILENAMES_OLD="jdk-7u${JAVA_VERSION_OLD}-linux-${dld}.tar.gz $FILENAMES_OLD"
done

# Must be modified for each release!!!
PARTNER_URL=http://download.oracle.com/otn-pub/java/jdk/7u45-b18/$FILENAME

db_get oracle-java7-installer/local
echo "$SHA256SUM_TGZ  $RET/$FILENAME" \
| sha256sum -c > /dev/null 2>&1 \
|| db_set oracle-java7-installer/local /var/cache/oracle-jdk7-installer

db_get oracle-java7-installer/local
echo "$SHA256SUM_TGZ  $RET/$FILENAME" \
| sha256sum -c > /dev/null 2>&1 \
|| db_set oracle-java7-installer/local /usr/lib/oracle-jdk7-installer-unpackdir

db_get oracle-java7-installer/local
echo "$SHA256SUM_TGZ  $RET/$FILENAME" \
| sha256sum -c > /dev/null 2>&1 \
|| db_reset oracle-java7-installer/local 

while true; do
    db_input medium oracle-java7-installer/local || true
    db_go
    db_get oracle-java7-installer/local
    if [ -d "$RET" -a -f "$RET"/$FILENAME ]; then
		LOCAL="true"
		break;
    elif [ "x$RET" = "x" ]; then
		break;
    fi
    db_reset oracle-java7-installer/not_exist || true
    db_reset oracle-java7-installer/local || true
    db_text medium oracle-java7-installer/not_exist || true
    db_go
done

exit 0
